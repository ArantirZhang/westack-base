services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: bms-mosquitto
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # WebSocket
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    networks:
      - bms-network
    restart: unless-stopped

  influxdb:
    image: influxdb:2.7
    container_name: bms-influxdb
    ports:
      - "8086:8086"   # HTTP API
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=bms-org
      - DOCKER_INFLUXDB_INIT_BUCKET=bms-metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-auth-token
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    networks:
      - bms-network
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: bms-memgraph
    ports:
      - "7687:7687"   # Bolt protocol
      - "3000:3000"   # Memgraph Lab (UI)
      - "7444:7444"   # Lab websocket
    environment:
      - MEMGRAPH="--log-level=WARNING"
    volumes:
      - memgraph-data:/var/lib/memgraph
      - memgraph-log:/var/log/memgraph
      - memgraph-etc:/etc/memgraph
      - ./src/database/graph-schema:/graph-schema:ro
    networks:
      - bms-network
    healthcheck:
      test: ["CMD", "echo", "RETURN 1;", "|", "mgconsole", "--host", "127.0.0.1", "--port", "7687"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  bms-data-layer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bms-app
    depends_on:
      influxdb:
        condition: service_healthy
      memgraph:
        condition: service_healthy
      mosquitto:
        condition: service_started
    environment:
      - NODE_ENV=production

      # MQTT Configuration
      - MQTT_BROKER_URL=mqtt://mosquitto:1883
      - MQTT_CLIENT_ID=bms-data-layer
      - MQTT_TOPIC_PATTERN=+/+/+/+/#
      - MQTT_QOS=1

      # InfluxDB Configuration
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=my-super-secret-auth-token
      - INFLUXDB_ORG=bms-org
      - INFLUXDB_BUCKET=bms-metrics
      - INFLUXDB_BATCH_SIZE=1000
      - INFLUXDB_FLUSH_INTERVAL=1000

      # Memgraph Configuration
      - MEMGRAPH_URI=bolt://memgraph:7687
      - MEMGRAPH_USER=
      - MEMGRAPH_PASSWORD=
      - MEMGRAPH_DATABASE=memgraph

      # API Configuration
      - API_PORT=8080
      - API_CORS_ORIGIN=*

      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json

      # Batch Write Configuration
      - BATCH_SIZE=1000
      - BATCH_TIMEOUT_MS=1000
    ports:
      - "8080:8080"   # API port
    volumes:
      - ./src:/app/src:ro
      - /app/node_modules
    networks:
      - bms-network
    restart: unless-stopped

volumes:
  mosquitto-data:
    driver: local
  mosquitto-logs:
    driver: local
  influxdb-data:
    driver: local
  influxdb-config:
    driver: local
  memgraph-data:
    driver: local
  memgraph-log:
    driver: local
  memgraph-etc:
    driver: local

networks:
  bms-network:
    driver: bridge
